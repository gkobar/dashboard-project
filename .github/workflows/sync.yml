name: Google Sheets Sync - Optimized

on:
  schedule:
    - cron: '*/30 * * * *'  # Her 30 dakika
  workflow_dispatch:  # Manuel Ã§alÄ±ÅŸtÄ±rma

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Download and optimize data from Google Sheets
      run: |
        # Google Sheets'ten CSV indir
        echo "ðŸ“Š Google Sheets'ten veri indiriliyor..."
        curl -L "https://docs.google.com/spreadsheets/d/1JUmhcit0KzPKppTJQGVxsWCuXCpYhmbL4KXCgTpdTyY/export?format=csv&gid=0" \
          -o raw_data.csv
        
        # Dosya boyutunu kontrol et
        echo "ðŸ“ Dosya boyutu:"
        ls -lh raw_data.csv
        
        # Ä°lk 1000 satÄ±rÄ± al (dashboard iÃ§in yeterli)
        echo "âœ‚ï¸ Veriyi optimize ediliyor..."
        head -n 1001 raw_data.csv > data.csv
        
        # Optimize edilmiÅŸ dosya boyutu
        echo "ðŸ“¦ Optimize edilmiÅŸ boyut:"
        ls -lh data.csv
        
        # SatÄ±r sayÄ±sÄ±nÄ± say
        echo "ðŸ“Š SatÄ±r sayÄ±sÄ±:"
        wc -l data.csv

    - name: Commit and push changes
      run: |
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions"
        
        # Sadece data.csv deÄŸiÅŸtiyse commit et
        if ! git diff --quiet data.csv; then
          git add data.csv
          git commit -m "Auto-update data $(date '+%Y-%m-%d %H:%M:%S UTC')"
          git push
          echo "âœ… Veri gÃ¼ncellendi ve commit edildi"
        else
          echo "ðŸ“Š Veri deÄŸiÅŸmedi, commit gerekli deÄŸil"
        fi

    - name: Create summary
      run: |
        echo "ðŸŽ¯ **Sync Summary**" >> $GITHUB_STEP_SUMMARY
        echo "- â° Sync Time: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“Š Records: $(tail -n +2 data.csv | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¦ File Size: $(ls -lh data.csv | awk '{print $5}')" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”— Raw URL: https://raw.githubusercontent.com/gkobar/dashboard-project/main/data.csv" >> $GITHUB_STEP_SUMMARY
