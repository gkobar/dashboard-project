<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maƒüaza Performans ve Stok Analizi</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 20px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 2rem; margin-right: 15px; }
        .title-section h1 { font-size: 1.8rem; color: #2d3748; margin-bottom: 5px; }
        .title-section .subtitle { color: #718096; font-size: 0.9rem; }
        .info-section { display: flex; gap: 20px; align-items: center; }
        .info-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: #4a5568; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; animation: pulse 2s infinite; }
        .status-dot.loading { background: #f6ad55; }
        .status-dot.success { background: #68d391; animation: none; }
        .status-dot.error { background: #fc8181; animation: none; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .loading-overlay.show { opacity: 1; visibility: visible; }
        .loading-content { background: white; padding: 40px; border-radius: 15px; text-align: center; max-width: 300px; }
        .loading-spinner { width: 50px; height: 50px; border: 4px solid #e2e8f0; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .filters-section, .search-section, .dashboard-section { background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .filters-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-weight: 600; margin-bottom: 5px; color: #2d3748; font-size: 0.9rem; }
        .filter-group select, .filter-group input { padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: border-color 0.2s; }
        .filter-group select:focus, .filter-group input:focus { outline: none; border-color: #667eea; }
        .search-input { width: 100%; padding: 15px; font-size: 16px; border: 2px solid #e2e8f0; border-radius: 10px; transition: border-color 0.2s; }
        .search-input:focus { outline: none; border-color: #667eea; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f7fafc; }
        .section-header h2 { color: #2d3748; font-size: 1.4rem; }
        .section-info { color: #718096; font-size: 0.9rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); }
        .stat-card h3 { font-size: 1.1rem; margin-bottom: 10px; opacity: 0.9; }
        .stat-card .value { font-size: 2rem; font-weight: bold; margin-bottom: 5px; }
        .table-container { overflow-x: auto; border-radius: 10px; border: 1px solid #e2e8f0; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .data-table th { background: #f7fafc; padding: 12px; text-align: left; font-weight: 600; color: #2d3748; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; }
        .data-table td { padding: 12px; border-bottom: 1px solid #e2e8f0; }
        .data-table tr:hover { background: #f7fafc; }
        .no-data { text-align: center; padding: 40px; color: #718096; }
        .no-data h3 { margin-bottom: 10px; color: #4a5568; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 10px; color: white; font-weight: 500; z-index: 1001; transform: translateX(400px); transition: transform 0.3s ease; }
        .notification.show { transform: translateX(0); }
        .notification.success { background: #48bb78; }
        .notification.error { background: #f56565; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; text-decoration: none; display: inline-block; text-align: center; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        @media (max-width: 768px) {
            .header { flex-direction: column; text-align: center; gap: 15px; }
            .info-section { flex-direction: column; gap: 10px; }
            .title-section h1 { font-size: 1.5rem; }
            .filters-row { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
            .container { padding: 10px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="display: flex; align-items: center;">
            <div class="logo">üè™</div>
            <div class="title-section">
                <h1>Maƒüaza Performans ve Stok Analizi</h1>
                <p class="subtitle">Maƒüaza Performans ve Stok Analizi</p>
            </div>
        </div>
        <div class="info-section">
            <div class="info-item">
                <span class="status-dot loading" id="statusDot"></span>
                <span id="statusText">Giri≈ü bekleniyor...</span>
            </div>
            <div class="info-item">
                <span class="file-icon">üìä</span>
                <span id="fileName">-</span>
            </div>
            <div class="info-item">
                <span class="time-icon">üïê</span>
                <span id="lastUpdate">-</span>
            </div>
            <div class="info-item" id="syncButton" style="display: none;">
                <button onclick="syncData()" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 600;">
                    üîÑ Senkron Et
                </button>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingDiv">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>Veriler y√ºkleniyor...</h3>
            <p>L√ºtfen bekleyin...</p>
        </div>
    </div>

    <div class="container">
        <div id="passwordSetup" style="display: block;">
            <div style="text-align: center; max-width: 400px; margin: 100px auto; background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);">
                <div style="font-size: 48px; margin-bottom: 20px;">üîê</div>
                <h2 style="margin-bottom: 10px; color: #1f2937; font-weight: 700;">Dashboard Giri≈üi</h2>
                <p style="margin-bottom: 30px; color: #6b7280; font-size: 14px;">Devam etmek i√ßin ≈üifrenizi girin</p>
                <input type="password" id="dashboardPassword" placeholder="≈ûifre" 
                       style="width: 100%; padding: 16px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px; margin-bottom: 20px; box-sizing: border-box;"
                       onkeypress="if(event.key==='Enter') checkPassword()">
                <button onclick="checkPassword()" 
                        style="width: 100%; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer;">
                    Giri≈ü Yap
                </button>
            </div>
        </div>

        <div class="filters-section" id="filtersDiv" style="display: none;">
            <h3 style="margin-bottom: 20px; color: #2d3748;">üîç Filtreler</h3>
            <div class="filters-row">
                <div class="filter-group">
                    <label for="account">Account:</label>
                    <select id="account"><option value="">T√ºm√º</option></select>
                </div>
                <div class="filter-group">
                    <label for="region">Region:</label>
                    <select id="region"><option value="">T√ºm√º</option></select>
                </div>
                <div class="filter-group">
                    <label for="city">City:</label>
                    <select id="city"><option value="">T√ºm√º</option></select>
                </div>
                <div class="filter-group">
                    <label for="store">Store:</label>
                    <select id="store"><option value="">T√ºm√º</option></select>
                </div>
            </div>
            <div class="filters-row">
                <div class="filter-group">
                    <label for="category">Category:</label>
                    <select id="category"><option value="">T√ºm√º</option></select>
                </div>
                <div class="filter-group">
                    <label for="subcat">Sub Category:</label>
                    <select id="subcat"><option value="">T√ºm√º</option></select>
                </div>
                <div class="filter-group">
                    <label for="brand">Brand:</label>
                    <select id="brand"><option value="">T√ºm√º</option></select>
                </div>
                <div class="filter-group">
                    <label for="apStatus">AP Status:</label>
                    <select id="apStatus"><option value="">T√ºm√º</option></select>
                </div>
            </div>
        </div>

        <div class="search-section" id="searchDiv" style="display: none;">
            <input type="text" id="search" class="search-input" placeholder="üîç √úr√ºn adƒ±, kodu veya herhangi bir deƒüer ile arama yapƒ±n...">
        </div>

        <div class="dashboard-section" id="statsDiv" style="display: none;">
            <div class="section-header">
                <h2>üìä √ñzet ƒ∞statistikler</h2>
                <span class="section-info">Filtrelenmi≈ü veriler</span>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Toplam √úr√ºn</h3>
                    <div class="value" id="totalProducts">0</div>
                </div>
                <div class="stat-card">
                    <h3>Aktif Maƒüaza</h3>
                    <div class="value" id="activeStores">0</div>
                </div>
                <div class="stat-card">
                    <h3>Toplam Kategori</h3>
                    <div class="value" id="totalCategories">0</div>
                </div>
                <div class="stat-card">
                    <h3>Toplam Marka</h3>
                    <div class="value" id="totalBrands">0</div>
                </div>
            </div>
        </div>

        <div class="dashboard-section" id="mainDashboard" style="display: none;">
            <div class="section-header">
                <h2>üìã √úr√ºn Listesi</h2>
                <span class="section-info" id="tableStats">- | 0 √ºr√ºn</span>
            </div>
            <div class="table-container">
                <div id="tableContent">
                    <div class="no-data">
                        <h3>üéØ Dashboard Hazƒ±r</h3>
                        <p>Veriler y√ºklendi ve analiz i√ßin hazƒ±r.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const DASHBOARD_PASSWORD = "dashboard123";
        const FALLBACK_URLS = [
            "https://gkobar.github.io/dashboard-project/data.csv",
            "https://docs.google.com/spreadsheets/d/1JUmhcit0KzPKppTJQGVxsWCuXCpYhmbL4KXCgTpdTyY/export?format=csv&gid=0"
        ];

        let lastSyncTime = null;
        let allData = [];
        let filteredData = [];

        async function syncData() {
            if (lastSyncTime && Date.now() - lastSyncTime < 30000) {
                showErrorMessage('‚è±Ô∏è √áok sƒ±k senkron yapƒ±yorsunuz. 30 saniye bekleyin.');
                return;
            }
            setStatus('loading', 'Manuel senkron yapƒ±lƒ±yor...');
            showSuccessMessage('üîÑ Senkronizasyon ba≈ülatƒ±ldƒ±...');
            try {
                await loadData();
                lastSyncTime = Date.now();
                showSuccessMessage('‚úÖ Senkronizasyon tamamlandƒ±!');
            } catch (error) {
                console.error('Sync error:', error);
                showErrorMessage('‚ùå Senkronizasyon ba≈üarƒ±sƒ±z!');
                setStatus('error', 'Senkron hatasƒ±');
            }
        }

        function checkPassword() {
            const password = document.getElementById('dashboardPassword').value.trim();
            if (password === DASHBOARD_PASSWORD) {
                showSuccessMessage('Giri≈ü ba≈üarƒ±lƒ±! Veriler y√ºkleniyor...');
                document.getElementById('passwordSetup').style.display = 'none';
                loadData();
            } else {
                showErrorMessage('Hatalƒ± ≈üifre!');
                document.getElementById('dashboardPassword').value = '';
            }
        }

        async function loadData() {
            let success = false;
            let lastError = null;

            for (let i = 0; i < FALLBACK_URLS.length && !success; i++) {
                try {
                    const url = FALLBACK_URLS[i];
                    const isGitHub = url.includes('gkobar.github.io');
                    const isDirectGoogle = url.includes('docs.google.com');
                    
                    let displaySource = isGitHub ? 'GitHub Pages' : 'Google Sheets';
                    setStatus('loading', `Veriler y√ºkleniyor... (${displaySource})`);
                    document.getElementById('loadingDiv').classList.add('show');
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {'Accept': 'text/csv, text/plain, */*'},
                        mode: 'cors',
                        cache: 'no-cache'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const csvContent = await response.text();
                    
                    if (!csvContent || csvContent.length < 50) {
                        throw new Error('Empty or invalid CSV content');
                    }
                    
                    if (!csvContent.includes(',') && !csvContent.includes('\t')) {
                        throw new Error('Invalid CSV format');
                    }
                    
                    if (!window.Papa) {
                        const script = document.createElement('script');
                        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js';
                        document.head.appendChild(script);
                        await new Promise((resolve, reject) => {
                            script.onload = resolve;
                            script.onerror = reject;
                        });
                    }
                    
                    const parsed = Papa.parse(csvContent, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true,
                        delimiter: csvContent.includes('\t') ? '\t' : ','
                    });

                    if (!parsed.data || parsed.data.length === 0) {
                        throw new Error('No data rows found in CSV');
                    }

                    const firstRow = parsed.data[0];
                    if (!firstRow || Object.keys(firstRow).length < 3) {
                        throw new Error('Invalid data structure');
                    }

                    allData = parsed.data;
                    filteredData = [...allData];
                    success = true;

                    setStatus('success', `Veriler y√ºklendi (${allData.length} kayƒ±t)`);
                    document.getElementById('fileName').textContent = displaySource;
                    document.getElementById('lastUpdate').textContent = 'Y√ºkleme: ' + new Date().toLocaleString('tr-TR');
                    
                    document.getElementById('loadingDiv').classList.remove('show');
                    showDashboard();
                    updateFilters();
                    updateTable();
                    updateStats();
                    
                    showSuccessMessage(`‚úÖ Veriler ${displaySource} √ºzerinden y√ºklendi!`);
                    
                } catch (error) {
                    console.warn(`Method ${i + 1} failed:`, error.message);
                    lastError = error;
                    continue;
                }
            }

            if (!success) {
                setStatus('error', 'T√ºm y√∂ntemler ba≈üarƒ±sƒ±z');
                document.getElementById('loadingDiv').classList.remove('show');
                showErrorMessage('Otomatik y√ºkleme ba≈üarƒ±sƒ±z. L√ºtfen manuel y√ºkleme kullanƒ±n.');
                showAdvancedOptions();
            }
        }

        function showAdvancedOptions() {
            const container = document.querySelector('.container');
            const optionsDiv = document.createElement('div');
            optionsDiv.innerHTML = `
                <div class="dashboard-section" style="text-align: center; border: 2px solid #fbbf24; background: #fffbeb;">
                    <h3 style="color: #d97706;">üìÅ Manuel Veri Y√ºkleme</h3>
                    <p style="margin: 20px 0; color: #92400e;">
                        Otomatik y√ºkleme ba≈üarƒ±sƒ±z oldu. Excel/CSV dosyanƒ±zƒ± manuel olarak y√ºkleyin.
                    </p>
                    <button onclick="document.getElementById('fileInput').click()" class="btn-primary" 
                            style="padding: 15px 30px; background: #6b7280; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; margin: 10px;">
                        üìÅ Dosya Se√ß
                    </button>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                </div>
            `;
            container.appendChild(optionsDiv);
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            setStatus('loading', 'Dosya i≈üleniyor...');
            document.getElementById('loadingDiv').classList.add('show');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    if (file.name.endsWith('.csv')) {
                        const csvContent = e.target.result;
                        const parsed = Papa.parse(csvContent, {
                            header: true,
                            dynamicTyping: true,
                            skipEmptyLines: true
                        });
                        processUploadedData(parsed.data, file.name);
                    } else {
                        loadExcelLib().then(() => {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, {type: 'array'});
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet);
                            processUploadedData(jsonData, file.name);
                        });
                    }
                } catch (error) {
                    setStatus('error', 'Dosya i≈üleme hatasƒ±');
                    document.getElementById('loadingDiv').classList.remove('show');
                    showErrorMessage('Dosya i≈ülenirken hata olu≈ütu!');
                }
            };
            
            if (file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        function loadExcelLib() {
            return new Promise((resolve, reject) => {
                if (window.XLSX) {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        function processUploadedData(data, fileName) {
            allData = data;
            filteredData = [...allData];
            
            setStatus('success', `Veriler y√ºklendi (${allData.length} kayƒ±t)`);
            document.getElementById('fileName').textContent = fileName;
            document.getElementById('lastUpdate').textContent = 'Y√ºkleme: ' + new Date().toLocaleString('tr-TR');
            
            document.getElementById('loadingDiv').classList.remove('show');
            showDashboard();
            updateFilters();
            updateTable();
            updateStats();
            
            showSuccessMessage('Dosya ba≈üarƒ±yla y√ºklendi!');
        }

        function showDashboard() {
            document.getElementById('filtersDiv').style.display = 'block';
            document.getElementById('searchDiv').style.display = 'block';
            document.getElementById('statsDiv').style.display = 'block';
            document.getElementById('mainDashboard').style.display = 'block';
            document.getElementById('syncButton').style.display = 'block';
        }

        function updateFilters() {
            const fields = ['account', 'region', 'city', 'store', 'category', 'subcat', 'brand', 'apStatus'];
            fields.forEach(field => {
                const select = document.getElementById(field);
                const values = [...new Set(allData.map(row => row[field]).filter(val => val))].sort();
                select.innerHTML = '<option value="">T√ºm√º</option>';
                values.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    select.appendChild(option);
                });
                select.addEventListener('change', filterData);
            });
            document.getElementById('search').addEventListener('input', filterData);
        }

        function filterData() {
            const search = document.getElementById('search').value.toLowerCase();
            const filters = {
                account: document.getElementById('account').value,
                region: document.getElementById('region').value,
                city: document.getElementById('city').value,
                store: document.getElementById('store').value,
                category: document.getElementById('category').value,
                subcat: document.getElementById('subcat').value,
                brand: document.getElementById('brand').value,
                apStatus: document.getElementById('apStatus').value
            };

            filteredData = allData.filter(row => {
                for (let key in filters) {
                    if (filters[key] && row[key] !== filters[key]) return false;
                }
                if (search) {
                    const searchText = Object.values(row).join(' ').toLowerCase();
                    if (!searchText.includes(search)) return false;
                }
                return true;
            });

            updateTable();
            updateStats();
        }

        function updateTable() {
            const content = document.getElementById('tableContent');
            const stats = document.getElementById('tableStats');
            
            if (filteredData.length === 0) {
                content.innerHTML = '<div class="no-data"><h3>üîç Veri Bulunamadƒ±</h3><p>Filtrelere uygun veri yok.</p></div>';
                stats.textContent = '0 √ºr√ºn';
                return;
            }

            const headers = Object.keys(filteredData[0]);
            const rows = filteredData.slice(0, 500);

            content.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                    </thead>
                    <tbody>
                        ${rows.map(row => `<tr>${headers.map(h => `<td>${row[h] || '-'}</td>`).join('')}</tr>`).join('')}
                    </tbody>
                </table>
            `;

            stats.textContent = `${filteredData.length} √ºr√ºn`;
        }

        function updateStats() {
            document.getElementById('totalProducts').textContent = filteredData.length.toLocaleString();
            document.getElementById('activeStores').textContent = new Set(filteredData.map(r => r.store).filter(v => v)).size;
            document.getElementById('totalCategories').textContent = new Set(filteredData.map(r => r.category).filter(v => v)).size;
            document.getElementById('totalBrands').textContent = new Set(filteredData.map(r => r.brand).filter(v => v)).size;
        }

        function setStatus(type, message) {
            document.getElementById('statusDot').className = `status-dot ${type}`;
            document.getElementById('statusText').textContent = message;
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        function showSuccessMessage(message) { showNotification(message, 'success'); }
        function showErrorMessage(message) { showNotification(message, 'error'); }

        function showPasswordSetup() {
            document.getElementById('passwordSetup').style.display = 'block';
            setTimeout(() => document.getElementById('dashboardPassword').focus(), 100);
        }

        document.addEventListener('DOMContentLoaded', showPasswordSetup);
