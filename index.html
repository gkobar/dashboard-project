<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Performance Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
        }

        .status-dot.loading { background: #f59e0b; animation: pulse 2s infinite; }
        .status-dot.error { background: #ef4444; }
        .status-dot.warning { background: #f59e0b; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #4f46e5;
            color: white;
        }

        .btn-primary:hover {
            background: #4338ca;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .content {
            padding: 30px;
        }

        .password-setup {
            max-width: 500px;
            margin: 50px auto;
            padding: 40px;
            background: #f8fafc;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #e2e8f0;
        }

        .password-setup h3 {
            color: #1f2937;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .password-setup p {
            color: #6b7280;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .loading-div {
            text-align: center;
            padding: 50px;
            display: none;
        }

        .loading-div.show {
            display: block;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .filters-container {
            background: #f8fafc;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 1px solid #e2e8f0;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group select, .filter-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .table-header {
            background: #4f46e5;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .table-stats {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8fafc;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e2e8f0;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        th:hover {
            background: #f1f5f9;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
        }

        tr:hover {
            background: #f8fafc;
        }

        .status-normal { background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .status-d√º≈ü√ºk { background: #fecaca; color: #991b1b; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .status-y√ºksek { background: #fed7aa; color: #9a3412; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .status-problem { background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .no-data h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #374151;
        }

        .message {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 600;
        }

        .message.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .message.error {
            background: #fecaca;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .message.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .status-bar { flex-direction: column; gap: 15px; }
            .filters-grid { grid-template-columns: 1fr; }
            .controls { flex-wrap: wrap; }
            
            table, thead, tbody, th, td, tr {
                display: block;
            }
            
            th { display: none; }
            
            tr {
                border: 1px solid #e2e8f0;
                margin-bottom: 10px;
                border-radius: 8px;
                padding: 10px;
            }
            
            td {
                border: none;
                padding: 5px 0;
                text-align: left;
            }
            
            td:before {
                content: attr(data-label) ": ";
                font-weight: bold;
                display: inline-block;
                width: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>üè™ Store Performance Dashboard</h1>
            <p>Maƒüaza Performans ve Stok Analizi</p>
        </div>

        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Sistem hazƒ±r</span>
            </div>
            
            <div class="controls">
                <button class="btn btn-primary" onclick="loadExcel()">üìÅ Excel Y√ºkle & Kaydet</button>
                <button class="btn btn-secondary" onclick="refreshData()">üîÑ Yenile</button>
                <small id="lastUpdate">GitHub'dan otomatik y√ºkleme</small>
            </div>
        </div>

        <div class="content">
            <!-- Password Setup -->
            <div class="password-setup" id="passwordSetup">
                <h3>üîê Dashboard Giri≈üi</h3>
                <p>Dashboard'a eri≈ümek i√ßin ≈üifrenizi girin.</p>
                
                <div class="form-group">
                    <label for="dashboardPassword">Dashboard ≈ûifresi:</label>
                    <input type="password" id="dashboardPassword" placeholder="≈ûifrenizi girin..." />
                </div>
                
                <button class="btn btn-primary" onclick="checkPassword()">üîì Giri≈ü Yap</button>
                
                <div style="margin-top: 15px; padding: 10px; background: #dbeafe; border-radius: 8px; font-size: 14px;">
                    <strong>üí° ƒ∞pucu:</strong> ≈ûifre doƒüru olduƒüunda Excel verileri otomatik y√ºklenecek!
                </div>
            </div>

            <!-- Loading -->
            <div class="loading-div" id="loadingDiv">
                <div class="loading-spinner"></div>
                <h3>Dosya y√ºkleniyor...</h3>
                <p>L√ºtfen bekleyin, Excel verisi i≈üleniyor.</p>
            </div>

            <!-- Filters -->
            <div class="filters-container" id="filtersDiv" style="display: none;">
                <h3 style="margin-bottom: 20px; color: #374151;">üîç Filtreler</h3>
                
                <div class="filters-grid">
                    <div class="filter-group">
                        <label>üè¢ Account:</label>
                        <select id="account"><option value="">T√ºm√º</option></select>
                    </div>
                    <div class="filter-group">
                        <label>üåç Region:</label>
                        <select id="region"><option value="">T√ºm√º</option></select>
                    </div>
                    <div class="filter-group">
                        <label>üèôÔ∏è ≈ûehir:</label>
                        <select id="city"><option value="">T√ºm√º</option></select>
                    </div>
                    <div class="filter-group">
                        <label>üè™ Maƒüaza:</label>
                        <select id="store"><option value="">T√ºm√º</option></select>
                    </div>
                    <div class="filter-group">
                        <label>üì¶ Kategori:</label>
                        <select id="category"><option value="">T√ºm√º</option></select>
                    </div>
                    <div class="filter-group">
                        <label>üìÇ Alt Kategori:</label>
                        <select id="subcat"><option value="">T√ºm√º</option></select>
                    </div>
                    <div class="filter-group">
                        <label>üè∑Ô∏è Marka:</label>
                        <select id="brand"><option value="">T√ºm√º</option></select>
                    </div>
                    <div class="filter-group">
                        <label>‚ö° Devir Hƒ±zƒ±:</label>
                        <select id="turnover">
                            <option value="">T√ºm√º</option>
                            <option value="d√º≈ü√ºk">D√º≈ü√ºk (<1.5 ay)</option>
                            <option value="normal">Normal (1.5-3 ay)</option>
                            <option value="y√ºksek">Y√ºksek (>3 ay)</option>
                            <option value="problem">Problem (Satƒ±≈ü Durmu≈ü)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>üìä Stok Durumu:</label>
                        <select id="status">
                            <option value="">T√ºm√º</option>
                            <option value="normal">Normal</option>
                            <option value="d√º≈ü√ºk">D√º≈ü√ºk Stok</option>
                            <option value="y√ºksek">Y√ºksek Stok</option>
                            <option value="problem">Satƒ±≈ü Durmu≈ü</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>üìã A/P Durumu:</label>
                        <select id="apStatus">
                            <option value="Aktif" selected>Aktif</option>
                            <option value="Pasif">Pasif</option>
                            <option value="">T√ºm√º</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>üîç √úr√ºn Ara:</label>
                        <input type="text" id="search" placeholder="√úr√ºn ara..." />
                    </div>
                </div>

                <div class="filter-actions">
                    <button class="btn btn-primary" onclick="resetFilters()">üîç Filtreleri Sƒ±fƒ±rla</button>
                    <span id="filterCount" style="margin-left: 15px; font-weight: 600; color: #4f46e5;"></span>
                </div>
            </div>

            <!-- Table -->
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">üìã √úr√ºn Listesi</div>
                    <div class="table-stats">
                        <span id="fileName">-</span> | 
                        <span id="tableStats">0 √ºr√ºn</span>
                    </div>
                </div>
                
                <div id="tableContent">
                    <div class="no-data">
                        <h3>üìä Dashboard Hazƒ±r</h3>
                        <p>L√ºtfen √∂nce giri≈ü yapƒ±n</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let allData = [];
        let latestDate = null;
        let processedData = [];
        let filteredData = [];
        let currentSort = { column: 'code', direction: 'asc' };
        let isAuthenticated = false;

        // Dashboard Configuration
        const DASHBOARD_PASSWORD = "dashboard123";
        const GITHUB_CONFIG = {
            username: "gkobar",
            repo: "dashboard-project"
        };

        // Password Check Function
        function checkPassword() {
            const inputPassword = document.getElementById('dashboardPassword').value.trim();
            
            if (inputPassword === DASHBOARD_PASSWORD) {
                isAuthenticated = true;
                showSuccessMessage('Giri≈ü ba≈üarƒ±lƒ±! Veriler y√ºkleniyor...');
                document.getElementById('passwordSetup').style.display = 'none';
                loadExcelFromGitHub();
            } else {
                showErrorMessage('Hatalƒ± ≈üifre! Tekrar deneyin.');
                document.getElementById('dashboardPassword').value = '';
                document.getElementById('dashboardPassword').focus();
            }
        }

        // Setup password input
        function setupPasswordInput() {
            const passwordInput = document.getElementById('dashboardPassword');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkPassword();
                    }
                });
                passwordInput.focus();
            }
        }

        // Show password setup
        function showPasswordSetup() {
            setStatus('warning', 'Giri≈ü gerekli');
            document.getElementById('passwordSetup').style.display = 'block';
            document.getElementById('filtersDiv').style.display = 'none';
            setupPasswordInput();
        }

        // Load Excel from GitHub
        async function loadExcelFromGitHub() {
            if (!isAuthenticated) {
                showPasswordSetup();
                return;
            }

            setStatus('loading', 'GitHub\'dan Excel y√ºkleniyor...');
            document.getElementById('loadingDiv').classList.add('show');

            try {
                const url = `https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/main/store-data.xlsx`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Excel dosyasƒ± bulunamadƒ±');
                }

                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                allData = jsonData;
                findLatestDate();

                setStatus('success', 'GitHub\'dan y√ºklendi (' + allData.length + ' kayƒ±t)');
                document.getElementById('fileName').textContent = 'store-data.xlsx (GitHub)';
                document.getElementById('lastUpdate').textContent = 'Son g√ºncelleme: ' + new Date().toLocaleString('tr-TR');
                
                document.getElementById('loadingDiv').classList.remove('show');
                document.getElementById('filtersDiv').style.display = 'block';
                
                updateCascadeFilters();
                processAllData();
                
                showSuccessMessage('Excel GitHub\'dan ba≈üarƒ±yla y√ºklendi!');

            } catch (error) {
                console.log('GitHub\'dan y√ºkleme ba≈üarƒ±sƒ±z:', error.message);
                document.getElementById('loadingDiv').classList.remove('show');
                showExcelUploadInterface();
            }
        }

        // Show Excel upload interface
        function showExcelUploadInterface() {
            setStatus('warning', 'Excel dosyasƒ± bekleniyor');
            document.getElementById('filtersDiv').style.display = 'block';
            document.getElementById('tableContent').innerHTML = `
                <div class="no-data">
                    <h3>üìÅ Excel Dosyasƒ± Bulunamadƒ±</h3>
                    <p>GitHub'da store-data.xlsx dosyasƒ± bulunamadƒ±.</p>
                    <p>L√ºtfen Excel dosyanƒ±zƒ± GitHub repository'sine y√ºkleyin.</p>
                    <button class="btn btn-primary" onclick="showUploadInstructions()" style="margin-top: 15px;">
                        üìã Y√ºkleme Talimatlarƒ±
                    </button>
                </div>
            `;
        }

        // Show upload instructions
        function showUploadInstructions() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 2000; display: flex;
                justify-content: center; align-items: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; padding: 30px; border-radius: 15px; max-width: 600px;
                box-shadow: 0 25px 50px rgba(0,0,0,0.25); text-align: center;
            `;
            
            content.innerHTML = `
                <h3 style="margin-bottom: 20px; color: #374151;">üìÅ Excel Dosyasƒ± Y√ºkleme</h3>
                <p style="margin-bottom: 20px; color: #6b7280; line-height: 1.5;">
                    Dashboard'ƒ±n √ßalƒ±≈ümasƒ± i√ßin Excel dosyanƒ±zƒ± GitHub'a y√ºklemeniz gerekiyor:
                </p>
                
                <div style="background: #f8fafc; padding: 20px; border-radius: 10px; text-align: left; margin: 20px 0;">
                    <strong>üìã Adƒ±mlar:</strong><br><br>
                    <strong>1.</strong> <a href="https://github.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}" target="_blank" style="color: #3b82f6;">GitHub Repository'nize gidin</a><br>
                    <strong>2.</strong> "Add file" ‚Üí "Upload files" tƒ±klayƒ±n<br>
                    <strong>3.</strong> Excel dosyanƒ±zƒ± s√ºr√ºkleyin<br>
                    <strong>4.</strong> Dosya adƒ±nƒ± <code>store-data.xlsx</code> olarak deƒüi≈ütirin<br>
                    <strong>5.</strong> "Commit changes" tƒ±klayƒ±n<br>
                    <strong>6.</strong> Bu sayfayƒ± yenileyin (F5)<br>
                </div>
                
                <button onclick="this.parentElement.parentElement.remove()" 
                        style="background: #3b82f6; color: white; border: none; padding: 10px 20px; 
                               border-radius: 8px; cursor: pointer; margin-top: 10px;">
                    Anladƒ±m
                </button>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        // Find latest date in data
        function findLatestDate() {
            if (allData.length === 0) return;
            
            const dates = [];
            allData.forEach(row => {
                if (row.Date) {
                    const date = new Date(row.Date);
                    if (!isNaN(date.getTime())) {
                        dates.push(date);
                    }
                }
            });
            
            if (dates.length > 0) {
                latestDate = new Date(Math.max(...dates));
                console.log('Latest date found:', latestDate.toLocaleDateString('tr-TR'));
            } else {
                latestDate = new Date(); // Fallback to today
            }
        }

        // Update cascade filters
        function updateCascadeFilters() {
            const accounts = [...new Set(allData.map(row => row.ACCOUNT).filter(Boolean))].sort();
            const regions = [...new Set(allData.map(row => row.B√ñLGE).filter(Boolean))].sort();
            const cities = [...new Set(allData.map(row => row.≈ûEHƒ∞R).filter(Boolean))].sort();
            const stores = [...new Set(allData.map(row => row.STORE).filter(Boolean))].sort();
            const categories = [...new Set(allData.map(row => row['√úst Kategori']).filter(Boolean))].sort();
            const brands = [...new Set(allData.map(row => row.Marka).filter(Boolean))].sort();

            updateSelectOptions('account', accounts);
            updateSelectOptions('region', regions);
            updateSelectOptions('city', cities);
            updateSelectOptions('store', stores);
            updateSelectOptions('category', categories);
            updateSelectOptions('brand', brands);
        }

        // Update select options with current value preservation
        function updateSelectOptions(selectId, options) {
            const select = document.getElementById(selectId);
            if (select) {
                const currentValue = select.value;
                select.innerHTML = '<option value="">T√ºm√º</option>';
                options.forEach(option => {
                    const selected = option === currentValue ? 'selected' : '';
                    select.innerHTML += `<option value="${option}" ${selected}>${option}</option>`;
                });
            }
        }

        // Process all data initially
        function processAllData() {
            processedData = processData(allData);
            filteredData = [...processedData];
            displayTable();
        }

        // Process data with dynamic month calculation - COMPLETELY FIXED VERSION
        function processData(rawData) {
            const groupedProducts = {};
            const today = latestDate || new Date();
            
            rawData.forEach(row => {
                const productKey = row.PRODUCTCODE || 'Unknown';
                
                if (!groupedProducts[productKey]) {
                    groupedProducts[productKey] = {
                        code: row.PRODUCTCODE || 'Unknown',
                        name: row['PRODUCT NAME'] || 'Unknown Product',
                        account: row.ACCOUNT || '',
                        region: row.B√ñLGE || '',
                        city: row.≈ûEHƒ∞R || '',
                        store: 'Multiple Stores', // Birden fazla maƒüaza i√ßin
                        category: row['√úst Kategori'] || '',      
                        subCategory: row.KATEGORI || '',          
                        brand: row.Marka || '',
                        totalStock: 0, // Toplam stok
                        monthlyData: {},
                        stockData: [],
                        salesData: [],
                        currentMonthSales: 0,
                        currentMonthName: '',
                        storeCount: new Set() // Ka√ß maƒüazada var
                    };
                }
                
                const product = groupedProducts[productKey];
                const monthName = row.MONTHS || '';
                const year = row.YEAR || today.getFullYear();
                const fullMonthKey = `${monthName} ${year}`;
                
                // Maƒüaza sayƒ±sƒ±nƒ± takip et
                if (row.STORE) {
                    product.storeCount.add(row.STORE);
                }
                
                // Satƒ±≈ü ve stok verilerini ayrƒ± i≈üle
                if (row['SELL OUT/STOCK'] === 'Sell Out') {
                    const quantity = parseInt(row.QUANTITY) || 0;
                    if (!product.monthlyData[fullMonthKey]) {
                        product.monthlyData[fullMonthKey] = 0;
                    }
                    product.monthlyData[fullMonthKey] += quantity;
                    
                    // Sales data for calculations
                    product.salesData.push({
                        month: monthName,
                        year: year,
                        quantity: quantity,
                        fullKey: fullMonthKey,
                        store: row.STORE
                    });
                    
                    // Current month sales
                    const currentMonthKey = today.toLocaleString('tr-TR', { month: 'long', year: 'numeric' });
                    if (fullMonthKey === currentMonthKey) {
                        product.currentMonthSales += quantity;
                        product.currentMonthName = fullMonthKey;
                    }
                    
                } else if (row['SELL OUT/STOCK'] === 'Stock') {
                    product.stockData.push({
                        month: monthName,
                        year: year,
                        quantity: parseInt(row.QUANTITY) || 0,
                        store: row.STORE
                    });
                }
            });

            return Object.values(groupedProducts).map(product => {
                // TOPLAM STOK HESAPLAMA - En son aylardaki t√ºm maƒüazalarƒ±n toplamƒ±
                if (product.stockData && product.stockData.length > 0) {
                    // En son tarihli stoklarƒ± bul
                    const sortedStocks = product.stockData.sort((a, b) => {
                        if (a.year !== b.year) return b.year - a.year;
                        const monthOrder = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 
                                          'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];
                        return monthOrder.indexOf(b.month) - monthOrder.indexOf(a.month);
                    });
                    
                    // En son tarihli stoklarƒ± al
                    const latestStocks = sortedStocks.filter(stock => 
                        stock.year === sortedStocks[0].year && 
                        stock.month === sortedStocks[0].month
                    );
                    
                    // T√ºm maƒüazalarƒ±n stokunu topla
                    product.totalStock = latestStocks.reduce((sum, stock) => sum + stock.quantity, 0);
                } else {
                    product.totalStock = 0;
                }

                // Forecast calculation - FIXED
                let forecast = 0;
                if (product.currentMonthSales > 0 && latestDate) {
                    const currentDay = latestDate.getDate();
                    const daysInMonth = new Date(latestDate.getFullYear(), latestDate.getMonth() + 1, 0).getDate();
                    const remainingDays = daysInMonth - currentDay;
                    
                    if (remainingDays > 0) {
                        const avgDaily = product.currentMonthSales / currentDay;
                        forecast = product.currentMonthSales + (avgDaily * remainingDays);
                    } else {
                        forecast = product.currentMonthSales;
                    }
                }
                
                // Calculate past 3 months data - FIXED
                const past3Months = {};
                for (let i = 1; i <= 3; i++) {
                    const pastDate = new Date(today.getFullYear(), today.getMonth() - i, 1);
                    const monthKey = pastDate.toLocaleString('tr-TR', { month: 'long', year: 'numeric' });
                    past3Months[monthKey] = product.monthlyData[monthKey] || 0;
                }
                
                // Calculate turnover rate - FIXED
                const recentSalesData = product.salesData.filter(sale => {
                    const saleDate = new Date(sale.year, getMonthIndex(sale.month), 1);
                    const threeMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 3, 1);
                    return saleDate >= threeMonthsAgo;
                });
                
                let monthlySales = 0;
                if (recentSalesData.length > 0) {
                    const totalRecentSales = recentSalesData.reduce((sum, sale) => sum + sale.quantity, 0);
                    const monthsWithSales = new Set(recentSalesData.map(sale => sale.fullKey)).size;
                    monthlySales = monthsWithSales > 0 ? totalRecentSales / monthsWithSales : 0;
                }
                
                let turnover = 0;
                let turnoverStatus = 'normal';
                
                if (product.totalStock > 0 && monthlySales > 0) {
                    turnover = product.totalStock / monthlySales;
                    if (turnover > 3) {
                        turnoverStatus = 'y√ºksek';
                    } else if (turnover < 1.5) {
                        turnoverStatus = 'd√º≈ü√ºk';
                    } else {
                        turnoverStatus = 'normal';
                    }
                } else if (product.totalStock > 0 && monthlySales === 0) {
                    turnover = 999; // Very high turnover
                    turnoverStatus = 'problem';
                } else if (product.totalStock === 0 && monthlySales > 0) {
                    turnover = 0;
                    turnoverStatus = 'd√º≈ü√ºk';
                } else {
                    turnover = 0;
                    turnoverStatus = 'normal';
                }

                const totalSales = Object.values(product.monthlyData).reduce((a, b) => a + b, 0);

                // Maƒüaza bilgisi g√ºncelle
                const storeCount = product.storeCount.size;
                product.store = storeCount === 1 ? 
                    Array.from(product.storeCount)[0] : 
                    `${storeCount} Maƒüaza`;

                return {
                    ...product,
                    stock: product.totalStock, // Eski stock yerine totalStock kullan
                    forecast: Math.round(forecast),
                    turnover: turnover === 999 ? 'Stock Out' : parseFloat(turnover.toFixed(2)),
                    status: turnoverStatus,
                    totalSales: totalSales,
                    past3Months: past3Months,
                    monthlySales: monthlySales,
                    storeCount: storeCount
                };
            });
        }

        // Helper function to get month index
        function getMonthIndex(monthName) {
            const months = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 
                          'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];
            return months.indexOf(monthName);
        }

        // Filter and process with proper data handling - FIXED
        function filterAndProcess() {
            const searchTerm = document.getElementById('search').value.toLowerCase();
            const selectedAccount = document.getElementById('account').value;
            const selectedRegion = document.getElementById('region').value;
            const selectedCity = document.getElementById('city').value;
            const selectedStore = document.getElementById('store').value;
            const selectedCategory = document.getElementById('category').value;
            const selectedSubcat = document.getElementById('subcat').value;
            const selectedBrand = document.getElementById('brand').value;
            const selectedTurnover = document.getElementById('turnover').value;
            const selectedStatus = document.getElementById('status').value;
            const selectedAPStatus = document.getElementById('apStatus').value;

            // First filter raw data, then process
            let filteredRawData = allData.filter(row => {
                return (
                    (!selectedAccount || row.ACCOUNT === selectedAccount) &&
                    (!selectedRegion || row.B√ñLGE === selectedRegion) &&
                    (!selectedCity || row.≈ûEHƒ∞R === selectedCity) &&
                    (!selectedStore || row.STORE === selectedStore) &&
                    (!selectedCategory || row['√úst Kategori'] === selectedCategory) &&
                    (!selectedSubcat || row.KATEGORI === selectedSubcat) &&
                    (!selectedBrand || row.Marka === selectedBrand) &&
                    (!selectedAPStatus || row['A/P'] === selectedAPStatus)
                );
            });

            // Process filtered raw data
            const filteredProcessedData = processData(filteredRawData);

            // Apply remaining filters
            filteredData = filteredProcessedData.filter(product => {
                return (
                    (!searchTerm || product.name.toLowerCase().includes(searchTerm) || product.code.toLowerCase().includes(searchTerm)) &&
                    (!selectedTurnover || product.status === selectedTurnover) &&
                    (!selectedStatus || product.status === selectedStatus)
                );
            });

            displayTable();
        }

        // Display table with dynamic headers - UPDATED
        function displayTable() {
            const tableContent = document.getElementById('tableContent');
            
            if (filteredData.length === 0) {
                tableContent.innerHTML = `
                    <div class="no-data">
                        <h3>üìä Sonu√ß Bulunamadƒ±</h3>
                        <p>Se√ßilen filtrelere uygun √ºr√ºn bulunamadƒ±.</p>
                        <button class="btn btn-secondary" onclick="resetFilters()">üîÑ Filtreleri Temizle</button>
                    </div>
                `;
                return;
            }

            // Sort data
            const sortedData = [...filteredData].sort((a, b) => {
                let aVal = a[currentSort.column];
                let bVal = b[currentSort.column];
                
                // Handle special cases for past months
                if (currentSort.column.startsWith('past_')) {
                    const monthName = currentSort.column.replace('past_', '');
                    const today = latestDate || new Date();
                    const monthIndex = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 
                                      'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'].indexOf(monthName);
                    if (monthIndex !== -1) {
                        const pastDate = new Date(today.getFullYear(), today.getMonth() - (3 - monthIndex), 1);
                        const fullMonthKey = pastDate.toLocaleString('tr-TR', { month: 'long', year: 'numeric' });
                        aVal = a.past3Months[fullMonthKey] || 0;
                        bVal = b.past3Months[fullMonthKey] || 0;
                    }
                }
                
                // Convert to numbers if possible
                if (!isNaN(aVal) && !isNaN(bVal)) {
                    aVal = Number(aVal);
                    bVal = Number(bVal);
                }
                
                if (currentSort.direction === 'asc') {
                    if (typeof aVal === 'number' && typeof bVal === 'number') {
                        return aVal - bVal;
                    }
                    return String(aVal).localeCompare(String(bVal), 'tr-TR', { numeric: true });
                } else {
                    if (typeof aVal === 'number' && typeof bVal === 'number') {
                        return bVal - aVal;
                    }
                    return String(bVal).localeCompare(String(aVal), 'tr-TR', { numeric: true });
                }
            });

            // Dynamic headers
            let currentMonthName = '';
            let forecastHeader = 'Tahmin FC';
            let currentMonthHeader = 'Bu Ay';

            if (sortedData.length > 0 && sortedData[0].currentMonthName) {
                currentMonthName = sortedData[0].currentMonthName;
                const monthParts = currentMonthName.split(' ');
                if (monthParts.length > 0) {
                    forecastHeader = monthParts[0] + ' FC';
                    currentMonthHeader = monthParts[0];
                }
            }
            
            // Past 3 months headers
            const pastMonthsHeaders = [];
            const today = latestDate || new Date();
            for (let i = 1; i <= 3; i++) {
                const pastDate = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const monthName = pastDate.toLocaleString('tr-TR', { month: 'long' });
                pastMonthsHeaders.push(monthName);
            }

            // Create table HTML
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th onclick="sortTable('code')">Kod ${getSortIcon('code')}</th>
                            <th onclick="sortTable('name')">√úr√ºn Adƒ± ${getSortIcon('name')}</th>
                            <th onclick="sortTable('stock')">Stok ${getSortIcon('stock')}</th>
                            <th onclick="sortTable('forecast')">${forecastHeader} ${getSortIcon('forecast')}</th>
                            <th onclick="sortTable('currentMonthSales')">${currentMonthHeader} ${getSortIcon('currentMonthSales')}</th>
            `;

            pastMonthsHeaders.forEach(month => {
                tableHTML += `<th onclick="sortTable('past_${month}')">${month} ${getSortIcon('past_' + month)}</th>`;
            });

            tableHTML += `
                            <th onclick="sortTable('turnover')">Devir Hƒ±zƒ± ${getSortIcon('turnover')}</th>
                            <th onclick="sortTable('status')">Stok Durumu ${getSortIcon('status')}</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sortedData.forEach(product => {
                const turnoverDisplay = typeof product.turnover === 'number' ? 
                    product.turnover.toFixed(1) + ' ay' : product.turnover;
                
                const status = product.status || 'normal';
                const turnoverClass = `status-${status}`;
                
                tableHTML += `
                    <tr>
                        <td data-label="Kod">${product.code}</td>
                        <td data-label="√úr√ºn Adƒ±">${product.name}</td>
                        <td data-label="Stok">${(product.stock || 0).toLocaleString()}</td>
                        <td data-label="${forecastHeader}">${(product.forecast || 0).toLocaleString()}</td>
                        <td data-label="${currentMonthHeader}">${(product.currentMonthSales || 0).toLocaleString()}</td>
                `;
                
                pastMonthsHeaders.forEach((month, index) => {
                    const pastDate = new Date(today.getFullYear(), today.getMonth() - (index + 1), 1);
                    const fullMonthKey = pastDate.toLocaleString('tr-TR', { month: 'long', year: 'numeric' });
                    const monthValue = (product.past3Months && product.past3Months[fullMonthKey]) ? product.past3Months[fullMonthKey] : 0;
                    tableHTML += `<td data-label="${month}">${monthValue.toLocaleString()}</td>`;
                });
                
                tableHTML += `
                        <td data-label="Devir Hƒ±zƒ±">${turnoverDisplay}</td>
                        <td data-label="Stok Durumu"><span class="${turnoverClass}">${capitalizeFirst(status)}</span></td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            tableContent.innerHTML = tableHTML;

            document.getElementById('tableStats').textContent = `${filteredData.length} √ºr√ºn`;
        }

        // Get sort icon
        function getSortIcon(column) {
            if (currentSort.column === column) {
                return currentSort.direction === 'asc' ? '‚Üë' : '‚Üì';
            }
            return '‚Üï';
        }

        // Sort table
        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            displayTable();
        }

        // Capitalize first letter with safety check
        function capitalizeFirst(str) {
            if (!str || typeof str !== 'string') return 'Normal';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Update dependent filters with proper grouping
        function updateDependentFilters() {
            const selectedAccount = document.getElementById('account').value;
            const selectedRegion = document.getElementById('region').value;
            const selectedCity = document.getElementById('city').value;
            const selectedStore = document.getElementById('store').value;
            const selectedCategory = document.getElementById('category').value;

            // Geographic cascade - always apply previous selections
            let geoFilteredData = allData;

            // Build cumulative geographic filter
            if (selectedAccount) {
                geoFilteredData = geoFilteredData.filter(row => row.ACCOUNT === selectedAccount);
            }
            if (selectedRegion) {
                geoFilteredData = geoFilteredData.filter(row => row.B√ñLGE === selectedRegion);
            }
            if (selectedCity) {
                geoFilteredData = geoFilteredData.filter(row => row.≈ûEHƒ∞R === selectedCity);
            }
            if (selectedStore) {
                geoFilteredData = geoFilteredData.filter(row => row.STORE === selectedStore);
            }

            // Update next level options based on current selections
            if (!selectedRegion && selectedAccount) {
                const regions = [...new Set(allData.filter(row => row.ACCOUNT === selectedAccount).map(row => row.B√ñLGE).filter(Boolean))].sort();
                updateSelectOptions('region', regions);
            }
            
            if (!selectedCity && (selectedAccount || selectedRegion)) {
                let cityData = allData;
                if (selectedAccount) cityData = cityData.filter(row => row.ACCOUNT === selectedAccount);
                if (selectedRegion) cityData = cityData.filter(row => row.B√ñLGE === selectedRegion);
                const cities = [...new Set(cityData.map(row => row.≈ûEHƒ∞R).filter(Boolean))].sort();
                updateSelectOptions('city', cities);
            }
            
            if (!selectedStore && (selectedAccount || selectedRegion || selectedCity)) {
                let storeData = allData;
                if (selectedAccount) storeData = storeData.filter(row => row.ACCOUNT === selectedAccount);
                if (selectedRegion) storeData = storeData.filter(row => row.B√ñLGE === selectedRegion);
                if (selectedCity) storeData = storeData.filter(row => row.≈ûEHƒ∞R === selectedCity);
                const stores = [...new Set(storeData.map(row => row.STORE).filter(Boolean))].sort();
                updateSelectOptions('store', stores);
            }

            // Product cascade - independent from geographic
            let productFilteredData = allData;
            if (selectedCategory) {
                productFilteredData = productFilteredData.filter(row => row['√úst Kategori'] === selectedCategory);
            }

            // Update product cascade options
            const subcategories = [...new Set(productFilteredData.map(row => row.KATEGORI).filter(Boolean))].sort();
            updateSelectOptions('subcat', subcategories);

            // Independent filters - always show all available options
            const brands = [...new Set(allData.map(row => row.Marka).filter(Boolean))].sort();
            updateSelectOptions('brand', brands);
        }

        // Filter change handlers
        function onFilterChange() {
            updateDependentFilters();
            filterAndProcess();
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('search').value = '';
            document.getElementById('account').value = '';
            document.getElementById('region').value = '';
            document.getElementById('city').value = '';
            document.getElementById('store').value = '';
            document.getElementById('category').value = '';
            document.getElementById('subcat').value = '';
            document.getElementById('brand').value = '';
            document.getElementById('turnover').value = '';
            document.getElementById('status').value = '';
            document.getElementById('apStatus').value = 'Aktif';
            
            updateCascadeFilters();
            processAllData();
        }

        // Load Excel function
        function loadExcel() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                setStatus('loading', 'Excel dosyasƒ± i≈üleniyor...');
                document.getElementById('loadingDiv').classList.add('show');

                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);

                        allData = jsonData;
                        findLatestDate();

                        setStatus('success', 'Excel y√ºklendi (' + allData.length + ' kayƒ±t)');
                        document.getElementById('fileName').textContent = file.name;
                        document.getElementById('lastUpdate').textContent = 'Son g√ºncelleme: ' + new Date().toLocaleString('tr-TR');
                        
                        document.getElementById('loadingDiv').classList.remove('show');
                        document.getElementById('filtersDiv').style.display = 'block';
                        
                        updateCascadeFilters();
                        processAllData();
                        
                        showSuccessMessage('Excel ba≈üarƒ±yla y√ºklendi!');

                    } catch (error) {
                        setStatus('error', 'Excel i≈üleme hatasƒ±');
                        document.getElementById('loadingDiv').classList.remove('show');
                        showErrorMessage('Excel dosyasƒ± i≈ülenirken hata olu≈ütu: ' + error.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            };
            input.click();
        }

        // Refresh data
        function refreshData() {
            if (isAuthenticated) {
                loadExcelFromGitHub();
            } else {
                showPasswordSetup();
            }
        }

        // Set status
        function setStatus(type, message) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            statusDot.className = 'status-dot ' + type;
            statusText.textContent = message;
        }

        // Show messages
        function showSuccessMessage(message) {
            showMessage(message, 'success');
        }

        function showErrorMessage(message) {
            showMessage(message, 'error');
        }

        function showWarningMessage(message) {
            showMessage(message, 'warning');
        }

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            
            messageDiv.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 1000;
                padding: 15px 20px; border-radius: 8px; font-weight: 600;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            try {
                showPasswordSetup();

                // Event Listeners
                const searchInput = document.getElementById('search');
                if (searchInput) {
                    searchInput.addEventListener('input', filterAndProcess);
                }

                // Geographic Cascade Filters
                const geoCascadeSelects = ['account', 'region', 'city', 'store'];
                geoCascadeSelects.forEach(selectId => {
                    const element = document.getElementById(selectId);
                    if (element) {
                        element.addEventListener('change', onFilterChange);
                    }
                });

                // Product Cascade Filters  
                const productCascadeSelects = ['category', 'subcat'];
                productCascadeSelects.forEach(selectId => {
                    const element = document.getElementById(selectId);
                    if (element) {
                        element.addEventListener('change', onFilterChange);
                    }
                });

                // Independent Filters
                const independentSelects = ['apStatus', 'brand', 'turnover', 'status'];
                independentSelects.forEach(selectId => {
                    const element = document.getElementById(selectId);
                    if (element) {
                        element.addEventListener('change', filterAndProcess);
                    }
                });

            } catch (error) {
                console.error('Initialization error:', error);
                showErrorMessage('Sayfa y√ºklenirken hata olu≈ütu!');
            }
        });
    </script>
</body>
</html>
